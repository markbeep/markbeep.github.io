<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="chrome=1"><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><meta name=description content="Mark's Site"><title>Fusing Go Into Python - Hello, I&rsquo;m Mark</title><link rel="shortcut icon" href=/m.ico><link rel=stylesheet href=/css/main.min.c5514d3530979d291f3497facc20da1cec870028dbc2a3630b64bab8721bbe49.css integrity="sha256-xVFNNTCXnSkfNJf6zCDaHOyHACjbwqNjC2S6uHIbvkk=" crossorigin=anonymous media=screen><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Didact+Gothic"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://markc.su/tn.png"><meta name=twitter:title content="Fusing Go Into Python"><meta name=twitter:description content="For the upcoming Visionen release I&rsquo;ve written yet another techy article. Here&rsquo;s the article so you can get a little sneak peak and hopefully interest you into reading the Visionen once it&rsquo;s out :)
If you like coding in Python, but sometimes just want that extra speed for some functions, I have the perfect solution for you: We&rsquo;re going to build our own little library that can run compiled code inside Python."><meta property="og:title" content="Fusing Go Into Python"><meta property="og:description" content="For the upcoming Visionen release I&rsquo;ve written yet another techy article. Here&rsquo;s the article so you can get a little sneak peak and hopefully interest you into reading the Visionen once it&rsquo;s out :)
If you like coding in Python, but sometimes just want that extra speed for some functions, I have the perfect solution for you: We&rsquo;re going to build our own little library that can run compiled code inside Python."><meta property="og:type" content="article"><meta property="og:url" content="https://markc.su/posts/fusing-go-into-python/"><meta property="og:image" content="https://markc.su/tn.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-09-13T22:58:05+02:00"><meta property="article:modified_time" content="2023-09-13T22:58:05+02:00"><meta property="og:site_name" content="Hello, I'm Mark"><title>Fusing Go Into Python</title></head><body><header class="wrap flex-container"><h1>Fusing Go Into Python</h1></header><main class=wrap><div class=flex-container><aside role=complementary>Wed Sep 13, 2023 &#183; 629 words<div class=tag-container></div></aside><hr><article role=article><p><em>For the upcoming <a href=https://vis.ethz.ch/en/visionen/general>Visionen</a> release I&rsquo;ve written yet another techy article. Here&rsquo;s the article so you can get a little sneak peak and hopefully interest you into reading the Visionen once it&rsquo;s out :)</em></p><p>If you like coding in Python, but sometimes just want that extra speed for some functions, I have the perfect solution for you: We&rsquo;re going to build our own little library that can run compiled code inside Python. But instead of C, we&rsquo;re going to be using Golang, which is almost as easy to write as Python, but actually fast.</p><h3 id=setting-the-baselines class=anchor-link><a href=#setting-the-baselines>Setting the baselines<span class=pilcrow>&nbsp;¶</span></a></h3><p>For the Python test function we&rsquo;ll be using to benchmark I approached the <a href=https://en.wikipedia.org/wiki/Collatz_conjecture>Collatz conjecture</a> problem. Maybe we can find a proof along the way.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>collatz</span>(n: int):
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010> </span> <span style=color:#960050;background-color:#1e0010> </span> <span style=color:#66d9ef>if</span> n <span style=color:#f92672>%</span> <span style=color:#ae81ff>2</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>:
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010> </span> <span style=color:#960050;background-color:#1e0010> </span> <span style=color:#960050;background-color:#1e0010> </span> <span style=color:#960050;background-color:#1e0010> </span> <span style=color:#66d9ef>return</span> n <span style=color:#f92672>//</span> <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010> </span> <span style=color:#960050;background-color:#1e0010> </span> <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>3</span> <span style=color:#f92672>*</span> n <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>
</span></span></code></pre></div><p>Iterating over the Collatz function one billion times took around 1m10s on my machine. Now lets look at the pure Golang approach:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>collatz</span>(<span style=color:#a6e22e>n</span> <span style=color:#66d9ef>int</span>) <span style=color:#66d9ef>int</span> {
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010> </span> <span style=color:#960050;background-color:#1e0010> </span> <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>n</span><span style=color:#f92672>%</span><span style=color:#ae81ff>2</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010> </span> <span style=color:#960050;background-color:#1e0010> </span> <span style=color:#960050;background-color:#1e0010> </span> <span style=color:#960050;background-color:#1e0010> </span> <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>n</span> <span style=color:#f92672>/</span> <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010> </span> <span style=color:#960050;background-color:#1e0010> </span> }
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010> </span> <span style=color:#960050;background-color:#1e0010> </span> <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>3</span><span style=color:#f92672>*</span><span style=color:#a6e22e>n</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Using Go I was able to execute one billion iterations in only 600ms. That&rsquo;s quite a big difference. Lets see how close we can get to that performance with bindings inside Python.</p><h3 id=creating-the-bindings class=anchor-link><a href=#creating-the-bindings>Creating the bindings<span class=pilcrow>&nbsp;¶</span></a></h3><p>Creating the bindings is actually a lot simpler than one might think at first. First we&rsquo;ll look at the Go side.</p><h4 id=go-side class=anchor-link><a href=#go-side>Go-Side<span class=pilcrow>&nbsp;¶</span></a></h4><p>An important library we&rsquo;re using is called <a href=https://pkg.go.dev/cmd/cgo>cgo</a> which enables us to write C inside Golang. Fret not, we&rsquo;re not really going to be writing C code, but you could theoretically do some really cursed stuff if you wanted. By adding the comment <code>//export colatz</code> (no space after //) above our function in Go it will later be accessible in Python:</p><p>Our whole <code>main.go</code> file is as follows:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#e6db74>&#34;C&#34;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//export collatz
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>collatz</span>(<span style=color:#a6e22e>n</span> <span style=color:#66d9ef>int</span>) <span style=color:#66d9ef>int</span> {
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010> </span> <span style=color:#960050;background-color:#1e0010> </span> <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>n</span><span style=color:#f92672>%</span><span style=color:#ae81ff>2</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010> </span> <span style=color:#960050;background-color:#1e0010> </span> <span style=color:#960050;background-color:#1e0010> </span> <span style=color:#960050;background-color:#1e0010> </span> <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>n</span> <span style=color:#f92672>/</span> <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010> </span> <span style=color:#960050;background-color:#1e0010> </span> }
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010> </span> <span style=color:#960050;background-color:#1e0010> </span> <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>3</span><span style=color:#f92672>*</span><span style=color:#a6e22e>n</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {}
</span></span></code></pre></div><p>Now comes an important step. We don&rsquo;t want to simply compile this to an executable, we want to compile this to a C shared object file by running the following:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>go build -buildmode<span style=color:#f92672>=</span>c-shared -o library.so
</span></span></code></pre></div><h4 id=python-side class=anchor-link><a href=#python-side>Python-Side<span class=pilcrow>&nbsp;¶</span></a></h4><p>Back in our Python program we now want to import the generated <code>library.so</code> file so that we can call the Golang code. Here the Python <code>ctypes</code> library will play an important role:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> ctypes
</span></span><span style=display:flex><span>library <span style=color:#f92672>=</span> ctypes<span style=color:#f92672>.</span>cdll<span style=color:#f92672>.</span>LoadLibrary(<span style=color:#e6db74>&#34;./library.so&#34;</span>)
</span></span><span style=display:flex><span>go_collatz <span style=color:#f92672>=</span> library<span style=color:#f92672>.</span>collatz
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>fast_collatz</span>(n: int):
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010> </span> <span style=color:#960050;background-color:#1e0010> </span> go_collatz<span style=color:#f92672>.</span>argtypes <span style=color:#f92672>=</span> [ctypes<span style=color:#f92672>.</span>c_int] <span style=color:#75715e># First and only argument is an int</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010> </span> <span style=color:#960050;background-color:#1e0010> </span> go_collatz<span style=color:#f92672>.</span>restype <span style=color:#f92672>=</span> ctypes<span style=color:#f92672>.</span>c_int <span style=color:#75715e># Return value is also an int</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010> </span> <span style=color:#960050;background-color:#1e0010> </span> <span style=color:#66d9ef>return</span> go_collatz(n)
</span></span></code></pre></div><p>And we&rsquo;re done! We can now import and call <code>fast_collatz</code> wherever we want.</p><h4 id=houston-we-have-a-problem class=anchor-link><a href=#houston-we-have-a-problem>Houston we have a problem!<span class=pilcrow>&nbsp;¶</span></a></h4><p>But when we now want to run this cool new function a billion times we&rsquo;re suddenly greeted with the opposite of what we expected. It suddenly takes almost 20 minutes to execute. There is a huge overhead when accessing Python bindings. The solution for this is to simply throw more computation onto the Go side and have Python execute as little as possible. We can fix this by creating new functions which repeat Collatz for a given amount of iterations.</p><p>Golang:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>//export loopCollatz
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>loopCollatz</span>(<span style=color:#a6e22e>n</span>, <span style=color:#a6e22e>k</span> <span style=color:#66d9ef>int</span>) <span style=color:#66d9ef>int</span> {
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010> </span> <span style=color:#960050;background-color:#1e0010> </span> <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> &lt; <span style=color:#a6e22e>k</span>; <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span> {
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010> </span> <span style=color:#960050;background-color:#1e0010> </span> <span style=color:#960050;background-color:#1e0010> </span> <span style=color:#960050;background-color:#1e0010> </span> <span style=color:#a6e22e>n</span> = <span style=color:#a6e22e>collatz</span>(<span style=color:#a6e22e>n</span>)
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010> </span> <span style=color:#960050;background-color:#1e0010> </span> }
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010> </span> <span style=color:#960050;background-color:#1e0010> </span> <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>n</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Python:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>go_loop_collatz <span style=color:#f92672>=</span> library<span style=color:#f92672>.</span>loopCollatz
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>loop_collatz</span>(n: int, k: int):
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010> </span> <span style=color:#960050;background-color:#1e0010> </span> go_loop_collatz<span style=color:#f92672>.</span>argtypes <span style=color:#f92672>=</span> [ctypes<span style=color:#f92672>.</span>c_int, ctypes<span style=color:#f92672>.</span>c_int]
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010> </span> <span style=color:#960050;background-color:#1e0010> </span> go_loop_collatz<span style=color:#f92672>.</span>restype <span style=color:#f92672>=</span> ctypes<span style=color:#f92672>.</span>c_int
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010> </span> <span style=color:#960050;background-color:#1e0010> </span> <span style=color:#66d9ef>return</span> go_loop_collatz(n, k)
</span></span></code></pre></div><p>Executing this new <code>loop_collatz</code> function we get our expected execution time of 630ms. Only 30ms more than running it purely in Go, but a more than 100x speedup compared to our pure Python execution. The code is available in <a href=https://github.com/markbeep/Golang-Python-Bindings>this repository</a>, to easily see it as a whole.</p></div></article></div><nav role=navigation class="flex-container bottom-menu"><hr><p><script src=https://utteranc.es/client.js repo=markbeep/markbeep.github.io issue-term=pathname label=comments theme=dark-blue crossorigin=anonymous async></script><a href=/posts>back</a>
&#183;
<a href=/posts>posts</a>
&#183;
<a href=https://github.com/markbeep>github</a>
&#183;
<a href=/polyring>polyring</a>
&#183;
<a href=/about>who is mark?</a>
&#183;
<a href=/>main</a></p></nav></main><footer class="flex-container footer">Call me Sam, a theme for Hugo.</footer></body></html>